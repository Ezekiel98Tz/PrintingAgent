# Changes — 2025-11-08

This log summarizes all changes implemented today across UI, pipeline, and document handling.

## Highlights

- Preserve original DOCX formatting (fonts, sizes, styles) via an in-place edit mode
- Add mouse-wheel scrolling to the Config tab’s scrollable area
- Add loading indicators and button disabling for “Test LLM” and “Process”
- Extend the processing pipeline with save directory, review/auto-print, and output format controls
- Support custom save locations and smarter naming in the document handler

## UI Updates

- Config Tab
  - Mouse-wheel scrolling enabled inside `ScrollableFrame` (Windows/Mac/Linux).
  - Exposed `Preserve Formatting` toggle mapped to `PRESERVE_FORMATTING`.
  - Exposed `Auto Print` and `Require Confirmation` toggles (Agent Behavior).

- Test Tab
  - Added indeterminate progress bar and status text for “Test LLM”.
  - Disabled buttons during background processing to prevent duplicate actions.

- Process Tab
  - Added indeterminate progress bar and status text for “Process”.
  - Kept UI responsive by running processing in a background thread.
  - Supports choosing a save directory, review-before-print, auto-print, and output format.
  - Quick open locations and open processed file action available.

## Pipeline Changes (`main.py`)

- `process_document_pipeline(...)` enhanced to accept:
  - `save_dir`: custom save location
  - `review_before_print`: allow manual confirmation before printing
  - `auto_print`: print automatically when not in review mode
  - `output_format_override`: set output format (e.g., `docx`, `txt`)
- Conditional printing logic: respects `review_before_print` and `auto_print`.
- Returns summary including `printed` flag.
- Passes the original file path to the saver to enable formatting preservation for DOCX inputs.

## Document Handling (`core/document_handler.py`)

- Added `_save_as_docx_preserve_formatting(original_path, content, output_path)`:
  - Edits the original DOCX structure in-place to retain paragraph styles and run-level formatting.
  - Distributes improved text across existing runs to keep fonts/sizes/bold/italic/underline.
  - Avoids reshaping layout; extra lines beyond original paragraph count aren’t appended.

- Updated `save_processed_document(...)`:
  - Honors `PRESERVE_FORMATTING=true` for DOCX inputs by using the preservation mode.
  - Falls back to standard reconstruction if preservation fails.
  - Supports custom save directories and more stable output naming.
  - For PDF output, saves as DOCX first (conversion handled externally/by printer).

## Configuration (`config.py` and `.env`)

- `PRESERVE_FORMATTING=true` by default (configurable via `.env`).
- Exposes `AUTO_PRINT` and `REQUIRE_CONFIRMATION` in the UI, persisted via `.env`.

## WhatsApp Integration (observations)

- Real-time handling via Flask webhook (`core/whatsapp.py`), ready to route incoming media into the pipeline.
- Not changed today; can be wired to process attachments and reply automatically.

## Usage Tips

- Toggle `Preserve Formatting` for DOCX inputs to keep fonts/sizes/styles.
- Use `Require Confirmation` to review processed documents before printing.
- Choose `Save Directory` and `Output Format` from the Process tab as needed.

## Known Limitations

- Preservation mode is best-effort: complex mid-paragraph style changes may not be perfect.
- Extra paragraphs from AI output aren’t appended to avoid layout changes.
- PDF conversion remains external; pipeline prints DOCX directly.

## Next Work

- Diff-based paragraph alignment for better mapping when AI changes structure moderately.
- Wire WhatsApp webhook to automatically process attachments and send confirmations.